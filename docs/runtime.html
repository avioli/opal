<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <title>Opal Runtime</title>

  <link rel="stylesheet" href="../css/styles.css" type="text/css" media="screen" charset="utf-8">
  <link rel="stylesheet" href="../css/syntax.css" type="text/css" media="screen" charset="utf-8">
</head>
<body>
  <div class="content">
    <header>
      <nav>
        <ul>
          <li><a href="../docs.html">Back to Documentation</a></li>
        </ul>
      </nav>
    </header>
    <h1 id='opal_runtime'>Opal Runtime</h1>

<p>The opal runtime is written in javascript and uses native javascript features to make its implementation as fast as possible.</p>

<h2 id='object_model'>Object model</h2>

<p>Opals object model is directly based of c-ruby with the exception that <code>Object</code> is the root object in the hierarchy instead of <code>BasicObject</code>. <code>BasicObject</code> does not exist in Opal. As per ruby, metaclasses etc are all supported in Opal, so the object hierarchy is that of ruby 1.8 instead of ruby 1.9. The benefits of BasicObject would not be present in Opal, so it is ommitted.</p>

<h3 id='core_classes'>Core classes</h3>

<p>To be optimal, Opal uses native objects whenever possible. For this reason, a ruby array is just a javascript array. The same goes for Regular Expressions, Strings and Numbers. This helps opal be efficient. Procs are also just Functions.</p>

<h3 id='core_properties'>Core properties</h3>

<p>Every object/class in Opal has a couple of javascript properties that are runtime properties - the runtime and core classes use them to operate.</p>

<h4 id='k'>.$k</h4>

<p>This is the &#8220;klass&#8221; pointer and every object has one. An object instance uses this to point to its class. This may be a singleton class if applicable (to support singleton object classes).</p>

<h4 id='f'>.$f</h4>

<p>This is the flags property that identifies the type of object. Flags include <code>T_OBJECT</code>, <code>T_CLASS</code>, <code>T_STRING</code> etc .. every object has one (or more) of these bitwise-or together.</p>

<h4 id='id'>.$id</h4>

<p>This is the id property, and every object in Opal has a unique one. These are added on creation and are used by Hash, for example, to uniquel identify objects.</p>

<h4 id='h'>.$h</h4>

<p>Hash function - this is used to calculate the unique hash of an object. For all ruby objects this just returns its id, but for native bridged objects this does some internal mangling - see below.</p>

<h3 id='additional_class_properties'>Additional class properties.</h3>

<p>These properties are only for classes, and normal objects do not have them.</p>

<h4 id='included_in'>.$included_in</h4>

<p>An array of classes that this module is included in. This ensures that modules can only be included into a class once. Both classes and modules have this property, but only modules us it.</p>

<h4 id='m'>.$m</h4>

<p>Method table - this is a javascript object containing a list of mehtod names to method implementations. This is used by Module#include and <code>super</code> etc to get a list of methods defined on an actual class.</p>

<h4 id='methods'>.$methods</h4>

<p>Methods array - this is an array of method names that are the same as all the keys in <code>$m</code>. This is a useful way for quickly getting all methods defined on a class.</p>

<h4 id='a'>.$a</h4>

<p>Instance allocator - this is used by <code>Class#allocate</code> to create a new instance of itself. Classes in opal piggyback on prototypes, so this just allocates a new object ready to use.</p>

<h4 id='__classid__'>.__classid__</h4>

<p>The class name of the receiver class. This is fully qualified to include parent class names as well, e.g. <code>A::B::C</code>.</p>

<h4 id='s'>.$s</h4>

<p>Super - a simple pointer to the superclass for the receiver. Obviously used in super method lookups.</p>

<h4 id='c'>.$c</h4>

<p>Constants storage - used to lookup contants for the given class. This also uses javascript prototype inheritance to speed up name lookups.</p>
  </div>
</body>
</html>

